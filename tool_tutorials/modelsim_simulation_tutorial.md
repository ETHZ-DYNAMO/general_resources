# Using modelsim to run RTL simulation
> Modelsim SE : 10.7b \
> Detailed tutorial: [Link](https://users.ece.cmu.edu/~kbiswas/se_man.pdf)

## Basic simulation flow
> Installing and run modelsim please refer to [modelsim_installation_guide](/installation_guides/install_modelsim.md)

- `Step 1` : Create a working library
    ```
    # Create the working directory
    vlib work

    # Map logical work to physical work directory
    vmap work work
    ```
- `Step 2` : Compile design files
    ```
    # Compile Verilog
    vlog -work work -f ${Target_file_path}

    # Compile VHDL
    vcom -work work -f ${Target_file_path}
    ```
- `Step 3` : Run simulation
  ```
  # Loading the desig for simulation
  vsim <top_module_name>

  # Optional: if you want to dump the simulation results into a vcd file, add the following line
  vcd file <vcd_file_name>.vcd
  vcd add <desired_signal_name>

  # Run simulation
  run -all
  ```
- `Step 4` : Debug results

## Run simulation with coverage profiling
For using the coverage checking functionality, we first need to compile the source code with the `-cover` flag, Modelsim supports the following coverage type:
- `s` : statement
- `b` : branch
- `c` : condition
- `t` : toggle
- `x` : extended toggle, including `X` and `Z` signals

Then you need to add the flag during the compilation of your RTL code, like:
```
vlog -sv -work work -cover bcst -f <file_path> 
```

After compilation, your need to enable coverage report during simulation:
```
vsim -coverage <tb_module_name>
```

## Potential problems with coverage enabled simulation
> Skip the following desciption if you don't need the coverage report. =D
- If you are trying to enable the coverage report functionality with VHDL files generated by Dynamatic. You can not directly add the compilation flag in the provided `simulation.do` file. As it is written with `project XX` command, which doesn't support setting the compilation flag directly.
  - Solution : Directly change the `modelsim.ini` file, as all compilation flags are directly set in that file.
- If you are using the `vcom -cover bcst` command to compile VHDL files generated by Dynamatic, you may found the modelsim simulation crashed during compilation.
  - This is caused by the flag that modelsim automatically set, if you directly add `-cover bcst` flag to the `vcom` command without other specifications. Modelsim will translate it to:
    ```
    vcom -work work -2002 -explicit -cover bcsx -vopt -stats=none simple_example_1.vhd
    ```
    However, files generated by Dynamatic only works with standard `>= 2008`. Thus, please use the following command to do the compilation:
    ```
    vcom -work work -2008 -explicit -cover bcsx -vopt -stats=none simple_example_1.vhd
    ```


## Sample script - Complete flow
Following is a sample script to setup the modelsim environment, compile desired files, run the simulation and collect data. It ensures that you have a clean start environment. 
```tcl
# Compilation flag
set DEBUG OFF
set COVERAGE ON

# Set working directory
set LIB work

# If a simulation is loaded, quit it so that it compiles in a clean working library.
set STATUS [runStatus]
if {$STATUS ne "nodesign"} {
    quit -sim
}

# Start with a clean working library.
if { [file exists $LIB] == 1} {
    echo "lib exist"
    file delete -force -- $LIB
}

if ($COVERAGE == "ON") {
    # You can change the flag to bcsx for extended toggle profiling, including X and Z signal
    set COV_TYPE bcst
    set COV_SW -coverage
} else {
    set COV_TYPE 0
    set COV_SW ""
}

if {$DEBUG == "ON"} {
    set VOPT_ARG "+acc"
    echo $VOPT_ARG
    set DB_SW "-debugdb"
} else {
    set DB_SW ""
}



# Create library
vlib $LIB

# Compile the file, you can give multiple files here
vlog -sv -work $LIB -cover $COV_TYPE -f <file.list>

# Run simulation
vsim -voptargs=$VOPT_ARG $DB_SW $COV_SW -pedanticerrors -lib $LIB <top_level_tb>

if {$DEBUG == "ON"} {
    # Add signals that you want to debug from the waveform window
    add wave -r /dut/*
}

run -a

if {$COVERAGE == "ON"} {
    coverage report -summary -out myreport.txt
    coverage report -html
}

```

You can run the above script using modelsim, by:
```
vsim -do compile.tcl
```